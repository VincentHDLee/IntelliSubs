**项目文档：智字幕 (IntelliSubs) - AI驱动的字幕生成工具 (v1.1 - 日语市场版)**

**1. 项目背景与目标**

*   **背景：**
    我司（新媒体公司）目前内容生产流程中，视频剪辑后的字幕制作环节仍存在较大的人力成本和时间开销。现有工作流涉及Gemini生成分镜脚本，文生图/图生视频模型产出素材，剪映进行剪辑。**目前业务主要覆盖日本市场，内容为日语。** 成品视频需要SRT、LRC、ASS等格式字幕。
*   **目标：**
    开发一款名为“智字幕 (IntelliSubs)”的桌面应用软件（Windows平台优先），旨在自动化或半自动化地为成品视频（特别是**AI生成的标准日语人声音轨**）生成高质量的字幕文件。软件将利用先进的ASR（自动语音识别）技术和可选的LLM（大语言模型）进行文本优化，以提高小编的工作效率，缩短内容生产周期。
*   **核心价值：**
    *   显著降低日语字幕制作的人工成本和时间。
    *   提升字幕的准确性和规范性。
    *   简化小编的工作流程。

**2. 目标用户**

*   公司内部负责日语内容的新媒体小编、视频剪辑师。

**3. 核心功能需求**

*   **3.1. 输入模块**
    *   **主要输入：** 纯日语人声音频文件（如MP3, WAV, M4A）。
    *   **辅助输入：** 包含日语音轨的短视频文件（如MP4, MOV），软件自动提取音轨。
    *   **(可选) 参考脚本：** 日语文本文件（TXT, DOCX）。其主要用途是作为LLM优化时的上下文参考，帮助LLM理解专有名词或特定语境；次要用途是供用户对比查看ASR原始识别结果。程序不直接使用其进行强制校正。
    *   **输入/输出文件夹配置：**
        *   用户可以自定义输入文件夹（用于批量处理或选择源文件）和输出文件夹（用于存放生成的字幕文件）。
        *   若用户未设置，则默认输入文件夹为程序运行目录下的 `input` 文件夹，默认输出文件夹为程序运行目录下的 `output` 文件夹。这些默认文件夹将在程序首次尝试访问（如选择文件或执行转换任务）且文件夹不存在时自动创建。

*   **3.2. 音频预处理模块**
    *   **格式转换与标准化：** 自动将输入音频（如MP3）转换为ASR模型优化的格式（例如：16kHz采样率，单声道，16-bit WAV）。
    *   **(可选) 简单降噪：** 内置基础的降噪算法。鉴于音轨为AI生成标准语音，此功能优先级较低，主要应对意外情况。

*   **3.3. 语音识别 (ASR) 模块 (日语优化)**
    *   **引擎选择：**
        *   **本地部署优先：**
            *   **OpenAI Whisper:** 通过 `faster-whisper` 或官方 `openai-whisper` 库实现。**需确保使用的模型对日语有良好支持**（Whisper的多语言模型通常包含日语）。提供不同模型大小（base, small, medium等）的选择，以平衡速度与精度。
            *   **(调研) 其他日语ASR方案：** 调研是否有针对日语优化的、易于本地集成的开源或商业ASR SDK（如若有日本本土的优秀开源模型）。
        *   **设备自动选择与手动切换：** 程序启动时自动检测并优先使用可用GPU（CUDA/MPS）；若无兼容GPU、驱动问题或检测失败，则默认使用CPU模式，并向用户给出相应提示。用户可随时在界面上手动切换至CPU模式或（若有可用GPU时）GPU模式。
        *   **(未来扩展) 在线ASR服务：** 预留接口，支持用户配置并使用云服务商API（如OpenAI API, Google Cloud Speech-to-Text, 或日本本土云服务商的日语ASR API），需要用户自行提供API Key。早期版本可在UI中预留一个置灰的或标记为“未来功能”的API Key输入区域，以作提示。
    *   **输出：** 带精确时间戳（词级别或短语级别）的日语文本片段。

*   **3.4. 文本后处理与优化模块 (日语环境)**
    *   **ASR结果规范化：**
        *   合并过于零碎的识别片段（例如，基于时间戳间隔小于0.3-0.5秒且合计字数少于5-10个字符的片段进行尝试性合并，具体阈值可配置或通过实验确定）。
        *   基础标点符号补全（**考虑日语标点符号习惯，如句号「。」、逗号「、」等**）。初步可尝试基于语音停顿（通过ASR输出的相邻词或短语片段间的时间戳差值判断，例如大于0.7-1秒的停顿）或常见日语句末助词（如ね、よ、か、ぞ、ぜ、わ等）后添加句号「。」或问号「？」（若句末为「か」）。逗号「、」的添加初期可较为保守。
        *   去除常见的ASR识别错误或口头禅（**考虑日语中的情况**）。
    *   **自定义词典/替换规则 (日语)：** 允许用户通过简单的文本文件（如CSV格式：`原文,替换文` 或 JSON格式）配置日语词典。规则应支持精确匹配（大小写可选敏感/不敏感），用于特定日语品牌名、术语、人名、常见假名/汉字转换（如 `いんたーねっと,インターネット`）、特定ASR错词修正等的正确替换或标记。
    *   **(可选) LLM增强模块 (日语优化)：**
        *   通过OpenAI标准接口接入多个厂商的LLM（如GPT系列，或其他**对日语支持良好的LLM，如日本本土开发的LLM或国际LLM的日语优化版本**，用户自选并配置API Key）。
        *   **功能：** 日语智能标点、语法修正、文本润色、**可能的敬语/语体调整（若有需求）**。
        *   此模块可由用户选择是否启用。
    *   **字幕断句与分行 (日语)：**
        *   根据日语语义、标点、时长、每行字数限制（可配置，默认为例如20-25个全角字符或等效的40-50个半角字符，**需特别考虑日语字符宽度，1个全角约等于2个半角**）等因素，智能地将文本切分为适合阅读的字幕行。断句时优先考虑在标点符号后（如「。」、「、」、「？」、「！」）、助词后或语义自然的停顿点进行。

*   **3.5. 字幕导出模块**
    *   **支持格式：**
        *   SRT (SubRip Text) - 核心支持
        *   LRC (LyRiCs) - 支持
        *   ASS (Advanced SubStation Alpha) - 支持基础格式，不含复杂样式。
    *   **文件编码：** 默认为UTF-8 (普遍支持日语)。可考虑提供Shift_JIS作为备选（如果剪映等工具对特定日文字幕编码有偏好）。

*   **3.6. 用户界面 (UI) 模块 (Windows风格)**
    *   **类型：** 简洁易用的图形用户界面（桌面应用，使用PyQt5/6 或 CustomTkinter，确保Windows平台良好兼容性）。
    *   **核心操作：**
        *   文件/文件夹选择对话框（支持自定义输入/输出路径）。
        *   ASR引擎选择。
        *   Whisper模型大小选择。
        *   GPU/CPU模式切换。
        *   (可选) LLM增强启用及模型选择。
        *   启动字幕生成过程。
        *   进度显示与状态反馈。
        *   预览生成的日语字幕文本（初期为纯文本框展示，未来可考虑实现一个简单的带时间戳的文本滚动预览或与简易音频波形对应的预览界面）。
        *   选择导出格式并下载字幕文件。
    *   **语言：** UI界面语言初期可为中文（面向内部小编），未来可考虑支持日文界面。

**4. 非功能性需求**

*   **易用性：** 界面直观，操作简便，尽量减少用户配置负担。
*   **性能：**
    *   ASR处理速度：对于一段10分钟的标准AI日语音频，使用推荐的Whisper小型模型（如`small`），在主流消费级CPU（如Intel i5/AMD R5近三代产品）上应力争在2-3分钟内完成处理，在兼容的NVIDIA GPU（如GTX 1660/RTX 3050级别及以上）加速下应力争在30-60秒内完成。此为初步目标，具体视模型和硬件而定。
    *   UI响应：流畅不卡顿。
*   **准确性：** 日语ASR初始准确率高，LLM优化有效。
*   **可配置性：** 核心参数（如ASR引擎、模型大小、LLM选项、输入输出路径）可由用户选择和设置。
*   **可扩展性：** 模块化设计，方便未来添加新的ASR引擎（特别是针对日语的）、LLM模型或导出格式。语言相关处理逻辑（如标点规则、断句策略、LLM prompts、UI特定本地化文本等）应尽可能封装为可配置的模块或独立的资源文件（如JSON, YAML），方便未来通过添加新的“语言包”来支持其他语言。
*   **稳定性与错误处理：** 程序运行稳定，对常见错误有友好提示和处理机制。例如：
    *   输入文件格式不支持：清晰提示用户当前支持的格式列表。
    *   音频文件损坏或无法读取：提示文件可能已损坏或无读取权限。
    *   ASR模型文件缺失或损坏（本地ASR）：提示检查模型文件路径或重新下载/配置。
    *   （若使用在线服务）API Key无效或网络连接失败：提示检查API Key配置及网络连接状态。
    *   输出目录无写入权限：提示检查输出路径权限。
*   **资源占用：** 合理控制CPU、内存、显存占用。
*   **平台兼容性：** 优先保证在Windows 10/11上的良好运行。

**5. 系统架构 (高层次) - (与前版一致，但内部实现需考虑日语特性)**

```
+---------------------+      +-------------------------+      +---------------------+
|     用户界面 (UI)   |----->|      输入/输出模块       |<---->|    配置管理器       |
| (Windows, 日语支持) |      | (路径配置, 文件IO)      |      | (含日语相关配置)    |
+---------------------+      +-------------------------+      +---------------------+
          ^                           |
          |                           v
          |      +---------------------------------------+
          |      |             音频预处理模块             |
          |      | (格式转换, 标准化, 降噪[低优])       |
          |      +---------------------------------------+
          |                           |
          |                           v
          |      +---------------------------------------+
          |      |        语音识别 (ASR) 模块            |
          |      | (Whisper[日语], 其他日语ASR[调研])    |
          |      |  [GPU/CPU Aware]                      |
          |      +---------------------------------------+
          |                           |
          |                           v
          |      +---------------------------------------+
          |      |      文本后处理与优化模块 (日语)        |
          |      | (规范化, 断句分行, LLM增强[可选])     |
          |      +---------------------------------------+
          |                           |
          v                           v
+---------------------+      +-------------------------+
|  (未来)字幕编辑器   |      |      字幕格式化与导出模块   |
+---------------------+      | (SRT, LRC, ASS)         |
                         +-------------------------+
```

**6. 技术栈选型**

*   **编程语言：** Python 3.9+
*   **ASR实现：**
    *   OpenAI Whisper: `faster-whisper` (推荐) 或 `openai-whisper` 官方库。**建议在MVP开发前，针对`faster-whisper`支持的、对日语表现较好的不同模型大小（如 `base`, `small`, `medium`的多语言模型版本）进行一次简要的速度与准确性（基于小样本测试）评估，以便为MVP选择一个“性价比”最高的默认模型。**
    *   **(调研项) 其他日语ASR SDK。**
*   **音频处理：** `ffmpeg-python` (或直接调用`ffmpeg`命令行), `pydub`, `noisereduce` (低优先级)。
*   **LLM接入：** `openai` Python库（用于兼容OpenAI API的各模型，**选择对日语处理能力强的模型**）。若未来考虑接入不完全兼容OpenAI API格式的日本本土LLM，需预留通过适配器模式或开发独立接入模块的可能性。
*   **字幕处理：** `pysrt` (SRT), 自定义逻辑 (LRC, ASS)。
*   **用户界面 (GUI)：** PyQt5/6 或 CustomTkinter (针对Windows优化)。建议在MVP阶段就倾向一个框架以减少后续重构。若追求快速原型和简洁界面，CustomTkinter可能更合适初期；若预期UI交互会变得更复杂或需要更多高级控件，PyQt可能是更长远的选择（但学习曲线和打包体积稍大）。**MVP阶段初步倾向使用CustomTkinter。**
*   **依赖管理：** `venv` + `pip` + `requirements.txt` 或 `Poetry` / `PDM`。
*   **打包 (桌面应用)：** PyInstaller 或 Nuitka (针对Windows ` .exe` 打包)。
*   **配置文件：** JSON或INI文件。默认优先尝试在用户操作系统的标准应用数据目录（例如Windows下的 `%APPDATA%\IntelliSubs`）中存储配置文件；若程序启动时在程序根目录下检测到特定标记文件（例如 `make_portable.txt` 或 `config_in_exe_dir.flag`），则视为便携模式，配置文件将存储在程序运行的根目录下。
*   **日志：** `logging`模块。

**7. 开发阶段与路线图 (初步，日语侧重)**

*   **阶段一: MVP (Minimum Viable Product) - 日语核心功能**
    *   **目标：** 实现针对标准日语AI语音的核心ASR转写与SRT导出功能。
    *   **功能：**
        *   MP3/WAV日语音频输入。
        *   音频标准化与格式转换。
        *   集成 `faster-whisper` (根据预评估结果，选择一个对日语友好的小型模型，如 `small` 多语言模型)，支持CPU/GPU自动检测与手动切换。
        *   基础ASR日语结果直接转换为SRT格式输出。
        *   简单的GUI (如CustomTkinter) 进行文件选择、路径配置和启动。
        *   实现默认输入/输出文件夹及用户自定义功能。
    *   **产出：** 可用的基础日语字幕生成工具。

*   **阶段二: 功能增强与日语优化**
    *   **目标：** 完善核心功能，提升日语处理效果和用户体验。
    *   **功能：**
        *   UI界面优化 (在MVP阶段选用的CustomTkinter基础上)，提供ASR模型大小选择（如 base, small, medium）、GPU/CPU手动切换等功能。
        *   实现针对日语的规则化文本后处理（标点、自定义词典）。
        *   实现针对日语的智能断句与分行逻辑。
        *   支持LRC、ASS格式导出（考虑日语编码）。
        *   视频文件音轨提取。
    *   **产出：** 功能相对完善，易用的日语字幕工具。

*   **阶段三: 高级功能与扩展**
    *   **目标：** 引入LLM增强，提升日语字幕智能化水平。
    *   **功能：**
        *   集成LLM增强模块（可选启用），选择并测试对日语支持良好的LLM。
        *   (可选) 支持导入日语参考脚本进行对比或辅助。
        *   预留接口，为未来在线日语ASR服务集成做准备。
        *   更精细的错误处理和用户反馈。
    *   **产出：** 智能化的日语字幕生成与辅助编辑工具。

**8. 潜在风险与应对策略 (日语相关)**

*   **日语ASR准确率与特殊表达：**
    *   风险：即使是标准AI语音，日语中的同音异义词、敬语、特定口语表达可能仍有挑战。
    *   应对：优先选择Whisper的多语言模型中在日语上表现较好的版本（例如，根据社区反馈和初步测试，`medium`模型在准确性上可能优于`small`，但速度较慢，需权衡）；关注并调研是否有针对日语进行微调的开源Whisper模型或更专业的日语ASR SDK；LLM润色；自定义词典。
*   **日语LLM选择与效果：**
    *   风险：并非所有LLM都对日语有同样优秀的理解和生成能力。
    *   应对：在项目早期阶段即开始调研并列出几个潜在的、对日语支持较好的LLM备选项（例如，日本本土的Rinna系列、Stability AI Japanese InstructGLM，或国际主流LLM如GPT系列、Claude系列等的最新日语能力评估报告）；在实际集成前进行小规模测试对比其在标点、润色、语法修正等方面的效果。
*   **字符编码问题：**
    *   风险：日语字符在不同系统和软件间可能因编码问题（UTF-8, Shift_JIS等）导致乱码。
    *   应对：默认使用UTF-8，提供Shift_JIS作为导出选项（如果剪映等工具需要）。在文件读写时明确指定编码。

**9. 测试策略概要**

*   **单元测试：** 针对核心功能模块（如音频格式转换、ASR接口调用、文本规范化函数、字幕格式化逻辑等）编写单元测试，确保各模块按预期工作。
*   **集成测试：**
    *   准备具有代表性的日语测试音频样本（涵盖不同语速、少量背景音、AI生成音轨特点）。
    *   定义预期的ASR转写结果和字幕格式输出。
    *   自动化或半自动化地进行端到端测试，验证从音频输入到字幕文件生成的完整流程。
*   **用户验收测试 (UAT)：** 由内部小编团队使用实际工作中的音视频素材进行测试，重点评估易用性、准确性、性能以及与现有工作流的契合度。
*   **日语特性测试：** 特别关注日语ASR的准确性（常见词汇、敬语、片假名外来语等）、标点符号的正确性、断句分行的自然度。

**10. 日志记录规范**

*   **日志级别：**
    *   `DEBUG`: 用于开发调试，记录详细的程序执行步骤、变量状态、函数调用等。
    *   `INFO`: 记录关键的用户操作（如文件选择、开始处理、导出字幕）、程序生命周期事件（启动、关闭）、重要状态变更（如切换CPU/GPU模式）。
    *   `WARNING`: 记录潜在问题或非严重错误，程序仍可继续运行（如可选模块加载失败但核心功能可用、特定配置项无效等）。
    *   `ERROR`: 记录导致功能失败或程序异常的错误（如文件读写失败、ASR引擎初始化失败、API调用严重错误、未捕获的异常等）。
*   **日志内容：** 日志应包含时间戳、日志级别、模块名（或函数名）、以及清晰描述事件的消息。错误日志应尽可能包含错误类型和堆栈跟踪信息。
*   **日志输出：** 默认输出到用户应用数据目录下的日志文件（如 `IntelliSubs.log`），可按日期滚动或大小限制分割。UI界面可提供查看最新日志或打开日志文件夹的便捷方式。
*   **用户反馈：** 鼓励用户在遇到问题时附上日志文件，以便快速定位问题。

**11. 依赖管理与打包 (补充)**

*   **ASR模型文件：** 打包时，默认的、推荐的 `faster-whisper` 模型文件（如 `small` 模型）应作为程序资源一同打包进最终的可执行文件或安装包中，或在首次运行时提示用户自动下载到指定位置。用户选择其他模型时，程序应能正确加载用户指定路径的模型文件。
*   **FFmpeg依赖：** 若直接调用 `ffmpeg` 命令行，需确保用户系统已安装 `ffmpeg` 并配置到环境变量，或在程序包内集成一个便携版的 `ffmpeg`，并在调用时指定其路径。使用 `ffmpeg-python` 库通常能更好地管理此依赖。
*   **Windows打包目标：** 生成单一的 `.exe` 可执行文件（若可能，通过Nuitka配合静态链接或PyInstaller的 `--onefile` 模式），或一个包含主程序及所有依赖DLL的文件夹（绿色版）。提供 `.msi` 或 `.exe` 安装程序更佳。

**12. API Key 安全 (未来在线服务相关)**

*   **本地存储：** 用户提供的第三方服务API Key（如OpenAI API Key）将仅存储在用户本地计算机的配置文件中（例如，在第6节描述的配置文件内）。
*   **不上传：** 程序不会将用户API Key上传到开发者服务器或任何其他未经用户明确同意的远程位置。
*   **简单加密（可选考虑）：** 为增强本地存储的安全性，可考虑对配置文件中存储的API Key进行简单的对称加密（密钥可基于用户机器码生成或由用户设置一个主密码），但这会增加实现的复杂度。MVP阶段可暂不实现，但需在文档中提示用户自行妥善保管API Key。
*   **明示责任：** 在UI界面和文档中明确告知用户，API Key的安全性主要由用户负责，尤其是在共享计算机上使用时。建议用户使用独立的、权限受限的API Key。
